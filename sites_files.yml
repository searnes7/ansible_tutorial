---


- hosts: all
  become: true
  pre_tasks:

  - name: install updates (Rocky)
    tags: always
    dnf:
      update_only: yes
      update_cache: yes
    when: ansible_distribution == "Rocky"

  - name: install updates (Ubuntu)
    apt:
      upgrade: dist
      update_cache: yes
    when: ansible_distribution == "Ubuntu"

- hosts: all
  become: true
  tasks:

  - name: create NOPASS ansible user
    tags: always
    user:
      name: hammer
      groups: root

  - name: add ssh key for hammer
    tags: always
    authorized_key:
      user: hammer
      key: "sh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDHqqCX5IxNJWAITOj+asswOuNhWdE6GnRYCqqsUYXi/h6I3AH1HnSlvGo2M8ab+URLuF1aiabJjiJms8W3WvhH1vZkWwnJ9w9qZAIT8zxehtMrlnlykzxD8mtdt+tmBwUW+uA2U2ChWMg6z19ORgp6cqMYzCU0JDzrngMcsd9cQXz/yTk6BnMVf/Yg/MJsdpjaDp5eZ28WZ8IYPTgJRg/wD6F2ATQHtcONweJhsYLL/1PUTx0RlJU5NcK/j7TRGhz9NpylxF2IJnyTPVt1bSCztNxaaQ3aushBI9YpDYRtKr7dwwGhG28CCjXNAGK30uAlkeyFKa4WFGQvm+gM98NMkwtydsulEAQUMhFh5794h9vXVpzZeFJN7NJ3Lm7JNSL66MhQpPtDaM6EQykCTScYuToeiF+UN+iIgw17va5d4Rot/HpQL7PrbAA3P5G2kwA4ZgOmQ9AK3Yd4erJnSKnxvYLBLer9HHtZnP7cE/0e4lAylruTXKLtOcoSaLAuzEjyhy8WV4UVxUmkKTb01Cz+zgq0AtYNezJ/EXOfUtK4Dtq4Ny9oDPCIRqEFaO9P1Wb/zS7J+HklJG/dmxJcSoO7PNcYKBTSInmXE+ciYgeqwTGmDtknf5gF7VTsbotAH9wIFSj4GiM26IM9kuVBU9BtzeTKQyniqb/LJZ4XMq7T1Q== ansible_main"

  - name: add sudoers file
    tags: always
    copy:
      src: sudoer_hammer
      dest: /etc/sudoers.d/hammer
      owner: root
      group: root
      mode: 0440

- hosts: web_servers
  become: true
  tasks:
  - name: install epel-release
    tags: epel-release
    dnf:
      name:
        - epel-release
      state: present
        
  - name: install apache2 package (Rocky)
    tags: httpd,rocky
    package:
      name: 
        - httpd
        - php
      state: latest
    when: ansible_distribution == "Rocky"

  - name: change email add for admin
    tags: apache,rocky,httpd
    lineinfile:
      path: /etc/httpd/conf/httpd.conf
      regexp: '^ServerAdmin'
      line: ServerAdmin somebody@somewhere.net
    when: ansible_distribution == "Rocky"
    register: httpd

  - name: restart httpd (Rocky)
    tags: rocky,apache,httpd
    service:
      name: httpd
      state: restarted
    when: httpd.changed

  - name: Copy index to webserver
    tags: httpd,rocky
    copy:
      src: default_site.html
      dest: /var/www/html/index.html
      owner: root
      group: root
      mode: 0644    

  - name: Start Apache
    service:
      name: httpd
      state: started
      enabled: yes
    when: ansible_distribution == "Rocky"

- hosts: db_servers
  become: true
  tasks:

  - name: install MariaDB package Ubuntu
    tags: ubuntu,mariadb,db
    apt:
      name:
        - mariadb-server
      state: latest
    when: ansible_distribution == "Ubuntu"

- hosts: file_servers
  become: true
  tasks:

  - name: install samba package Ubuntu
    tags: ubuntu,samba
    apt:
      name:
        - samba
      state: latest
    when: ansible_distribution == "Ubuntu"




